####################
###   CORE      ###
##################

services:

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    privileged: true
    security_opt:
      - no-new-privileges:true
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - /var/run/docker.sock:/var/run/docker.sock:ro # socket associé à Docker

      - ${DOCKER_DATA_PATH}/portainer/data:/data  # Chemin absolu cohérent
    ports:
      - "${PORTAINER_HTTP}:9000"
      - "${PORTAINER_HTTPS}:9443"
    networks:
      - Homebox_Network

  pythonista:
    build: ./Services/Core/Pythonista
    ports:
      - "${PYTHONISTA_HTTP}:5000"
    environment:
      - NODE_ENV=production
      - FLASK_ENV=production
    restart: always
    networks:
      - Homebox_Network

  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
    # Connexion à la base de données
      DB_MYSQL_HOST: "nginx-proxy-manager-db"
      DB_MYSQL_PORT: 3306
      DB_MYSQL_USER: "${NPM_DB_USER}"
      DB_MYSQL_PASSWORD: "${NPM_DB_PASSWORD}"
      DB_MYSQL_NAME: "${NPM_DB_NAME}"
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - ${DOCKER_DATA_PATH}/nginx-proxy-manager/data:/data
      - ${DOCKER_DATA_PATH}/nginx-proxy-manager/letsencrypt:/etc/letsencrypt
    ports:
      - "${NGINX_PROXY_HTTP}:80"       # Port HTTP public
      - "${NGINX_PROXY_HTTPS}:443"     # Port HTTPS public
      - "${NGINX_PROXY_ADMIN}:81"      # Port interface d'administration
    depends_on:
      - nginx-proxy-manager-db
    networks:
      - Homebox_Network

  nginx-proxy-manager-db:
    image: jc21/mariadb-aria:latest
    container_name: nginx-proxy-manager-db
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

    environment:
      MYSQL_ROOT_PASSWORD: "${NPM_DB_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${NPM_DB_NAME}"
      MYSQL_USER: "${NPM_DB_USER}"
      MYSQL_PASSWORD: "${NPM_DB_PASSWORD}"
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - ${DOCKER_DATA_PATH}/nginx-proxy-manager/mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - Homebox_Network

#####################
###  Automation  ###
####################

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    privileged: false
    security_opt:
      - no-new-privileges:true
    environment:
      - TZ=Europe/Paris
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - ${DOCKER_DATA_PATH}/homeassistant/config:/config # configuration Home Assistant
      - /run/dbus:/run/dbus:ro # communication D-Bus pour Bluetooth/intégrations système
    ports:
      - "${HOMEASSISTANT_HTTP}:8123"
    networks:
      - Homebox_Network

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - ${DOCKER_DATA_PATH}/n8n/data:/home/node/.n8n # données n8n
    ports:
      - "${N8N_HTTP}:5678"
    environment:
      - TZ=Europe/Paris
      - N8N_HOST=${N8N_HOST:-0.0.0.0}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL}
      - GENERIC_TIMEZONE=Europe/Paris
      - N8N_SECURE_COOKIE= false
    user: "${PUID}:${PGID}" # permissions utilisateur (optionnel)
    networks:
      - Homebox_Network

  node-red:
    image: nodered/node-red:latest
    container_name: node-red
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - ${DOCKER_DATA_PATH}/node-red/data:/data # données Node-RED
    ports:
      - "${NODE_RED_HTTP}:1880"
    environment:
      - TZ=Europe/Paris
      - NODE_RED_ENABLE_SAFE_MODE=false
      - NODE_RED_ENABLE_PROJECTS=true
    user: "${PUID}:${PGID}" # permissions utilisateur (optionnel)
    networks:
      - Homebox_Network

####################
###  MONITORING ###
##################

  beszel:
    image: henrygd/beszel:latest
    container_name: beszel
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - ${DOCKER_DATA_PATH}/Beszel/data:/beszel_data # données Beszel
    ports:
      - "${BESZEL_HTTP}:8090"
    networks:
      - Homebox_Network

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro # métriques disque (optionnel)
    ports:
      - "${CADVISOR_HTTP}:8080"
    devices:
      - /dev/kmsg # pour les logs kernel (optionnel)
    privileged: true # nécessaire pour cAdvisor
    networks:
      - Homebox_Network

  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${DOCKER_DATA_PATH}/grafana/data:/var/lib/grafana
      - ${DOCKER_DATA_PATH}/grafana/provisioning:/etc/grafana/provisioning
    ports:
      - "${GRAFANA_HTTP}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    user: "${PUID}:${PGID}"
    networks:
      - Homebox_Network

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - /etc/localtime:/etc/localtime:ro # pour synchroniser l'heure avec l'hôte
      - ${DOCKER_DATA_PATH}/prometheus/config:/etc/prometheus # fichiers de configuration
      - ${DOCKER_DATA_PATH}/prometheus/data:/prometheus # données Prometheus
    ports:
      - "${PROMETHEUS_HTTP}:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d' # rétention des données (ajustable)
      - '--web.enable-lifecycle' # permet le reload de la config via API
    networks:
      - Homebox_Network

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    restart: unless-stopped
    environment:
      TZ: Europe/Paris
      WEBPASSWORD: ${PIHOLE_ADMIN_PASSWORD}
      DNSMASQ_LISTENING: all
    volumes:
      - ${DOCKER_DATA_PATH}/pihole/etc-pihole:/etc/pihole
      - ${DOCKER_DATA_PATH}/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    ports:
      - "${PIHOLE_TCP}:53/tcp"
      - "${PIHOLE_UDP}:53/udp"
      - "${PIHOLE_HTTP}:80"   # UI Pi-hole (évite conflit avec NPM)
    networks:
      - Homebox_Network

networks:
  Homebox_Network:
    name: ${HOMEBOX_NETWORK}
    external: true
